# E2E Validation Pipeline Contracts

**Version**: 1.0.0  
**Date**: 2025-10-30  
**Feature**: 001-e2e-terraform-validation

## Overview

This document defines the contracts (interfaces) for each stage of the E2E validation pipeline. These contracts ensure consistent behavior across different validation contexts (PR, main branch, manual runs).

## Pipeline Stages

The E2E validation pipeline consists of five sequential stages:

```
Build → Plan → Apply → Drift Check → Cleanup
```

Each stage has defined inputs, outputs, and success criteria.

---

## Stage 1: Build

### Purpose
Compile the Terraform provider binary from source code and prepare it for testing.

### Inputs

```yaml
required:
  - source_directory: string  # Path to provider source code
  - go_version: string        # Go version to use (e.g., "1.24.4")
  
optional:
  - build_flags: []string     # Additional build flags
  - cache_enabled: boolean    # Whether to use build cache (default: true)
```

### Outputs

```yaml
success:
  - provider_binary: string   # Path to compiled provider binary
  - binary_hash: string       # SHA256 hash of binary
  - build_log: string         # Path to build log file
  - build_duration: integer   # Build time in seconds
  
failure:
  - error_type: enum          # "compilation_error" | "dependency_error" | "timeout"
  - error_message: string     # Detailed error message
  - error_log: string         # Path to error log
```

### Success Criteria

1. Provider binary is created successfully
2. Binary is executable and has correct permissions (0755)
3. Binary responds to `--version` flag
4. Build completes within timeout (5 minutes)
5. No compilation errors or warnings

### Error Handling

| Error Type | Action | Exit Code |
|------------|--------|-----------|
| Compilation error | Fail pipeline, log error | 1 |
| Dependency error | Fail pipeline, suggest `go mod tidy` | 2 |
| Timeout | Fail pipeline, report slow build | 124 |
| Disk space | Fail pipeline, report resource issue | 28 |

### Example Success Output

```json
{
  "stage": "build",
  "status": "success",
  "provider_binary": "/tmp/terraform-provider-azurecaf",
  "binary_hash": "a1b2c3d4e5f6...",
  "build_log": "/tmp/build.log",
  "build_duration": 45,
  "timestamp": "2025-10-30T10:00:00Z"
}
```

---

## Stage 2: Plan

### Purpose
Execute `terraform init` and `terraform plan` to validate that the provider works correctly and generates expected names.

### Inputs

```yaml
required:
  - provider_binary: string      # Path to provider binary from Build stage
  - test_configuration: string   # Path to Terraform test configuration
  - terraform_version: string    # Terraform version to use (e.g., "1.8.0")
  
optional:
  - parallel_count: integer      # Number of parallel operations (default: 10)
  - plugin_cache_dir: string     # Terraform plugin cache directory
  - timeout_minutes: integer     # Plan timeout (default: 5)
```

### Outputs

```yaml
success:
  - plan_file: string            # Path to saved plan file
  - plan_output: string          # Human-readable plan output
  - plan_json: string            # JSON representation of plan
  - resources_to_create: integer # Number of resources in plan
  - generated_names: []string    # List of names generated by provider
  - plan_duration: integer       # Plan time in seconds
  
failure:
  - error_type: enum             # "init_error" | "plan_error" | "validation_error" | "timeout"
  - error_message: string        # Detailed error message
  - error_log: string            # Path to error log
  - failed_resource: string      # Resource that failed (if applicable)
```

### Success Criteria

1. `terraform init` completes without errors
2. Provider is installed correctly in plugin directory
3. `terraform plan` executes successfully
4. All generated names pass validation rules
5. Plan shows expected number of resources to create
6. No provider schema errors
7. Plan completes within timeout (5 minutes)

### Validation Checks

```yaml
name_validation:
  - name_length_within_bounds: boolean
  - name_matches_regex: boolean
  - name_follows_convention: boolean
  - no_invalid_characters: boolean
  
plan_validation:
  - no_errors: boolean
  - no_warnings: boolean
  - expected_resource_count: boolean
  - all_attributes_valid: boolean
```

### Error Handling

| Error Type | Action | Exit Code | Retry |
|------------|--------|-----------|-------|
| Init error | Fail pipeline, check provider path | 10 | No |
| Plan error | Fail pipeline, log resource error | 11 | No |
| Validation error | Fail pipeline, report name issue | 12 | No |
| Timeout | Fail pipeline, report slow plan | 124 | Yes (1x) |

### Example Success Output

```json
{
  "stage": "plan",
  "status": "success",
  "plan_file": "/tmp/terraform.tfplan",
  "plan_output": "Plan: 5 to add, 0 to change, 0 to destroy",
  "resources_to_create": 5,
  "generated_names": [
    "st-dev-testapp-001",
    "kv-dev-testapp-001",
    "rg-dev-testapp-001",
    "vnet-dev-testapp-001",
    "snet-dev-testapp-001"
  ],
  "plan_duration": 15,
  "timestamp": "2025-10-30T10:01:00Z"
}
```

---

## Stage 3: Apply

### Purpose
Execute `terraform apply` to create resources (or validate with no-op provider) and verify that generated names work in practice.

### Inputs

```yaml
required:
  - provider_binary: string      # Path to provider binary
  - plan_file: string            # Path to plan file from Plan stage
  - terraform_version: string    # Terraform version to use
  
optional:
  - auto_approve: boolean        # Auto-approve apply (default: true for CI)
  - parallelism: integer         # Parallel resource operations (default: 10)
  - timeout_minutes: integer     # Apply timeout (default: 15)
  - state_backend: string        # State backend config (default: local)
```

### Outputs

```yaml
success:
  - state_file: string           # Path to Terraform state file
  - apply_output: string         # Human-readable apply output
  - resources_created: integer   # Number of resources created
  - created_resources: []ResourceInfo  # Details of created resources
  - apply_duration: integer      # Apply time in seconds
  
failure:
  - error_type: enum             # "apply_error" | "resource_error" | "timeout" | "state_error"
  - error_message: string        # Detailed error message
  - error_log: string            # Path to error log
  - failed_resource: string      # Resource that failed
  - partial_apply: boolean       # Whether some resources were created
  - cleanup_required: boolean    # Whether cleanup is needed
```

### ResourceInfo Schema

```yaml
resource_type: string           # Azure resource type
resource_name: string           # Generated name
resource_id: string             # Terraform resource ID
provider_id: string             # Azure resource ID (if real resource)
created_at: timestamp           # Creation timestamp
```

### Success Criteria

1. `terraform apply` completes without errors
2. All planned resources are created successfully
3. State file is created and valid
4. Generated names are accepted (no validation errors)
5. Apply completes within timeout (15 minutes)
6. State is consistent with plan

### Validation Checks

```yaml
apply_validation:
  - all_resources_created: boolean
  - state_file_valid: boolean
  - no_errors: boolean
  - names_accepted: boolean
  
resource_validation:
  - naming_rules_followed: boolean
  - no_conflicts: boolean
  - all_required_attributes_set: boolean
```

### Error Handling

| Error Type | Action | Exit Code | Cleanup |
|------------|--------|-----------|---------|
| Apply error | Fail pipeline, log error | 20 | Yes |
| Resource error | Fail pipeline, report resource | 21 | Yes |
| Timeout | Fail pipeline, report slow apply | 124 | Yes |
| State error | Fail pipeline, report state issue | 22 | Yes |

### Example Success Output

```json
{
  "stage": "apply",
  "status": "success",
  "state_file": "/tmp/terraform.tfstate",
  "apply_output": "Apply complete! Resources: 5 added, 0 changed, 0 destroyed.",
  "resources_created": 5,
  "created_resources": [
    {
      "resource_type": "azurecaf_name.storage",
      "resource_name": "st-dev-testapp-001",
      "resource_id": "st-dev-testapp-001",
      "created_at": "2025-10-30T10:05:00Z"
    }
  ],
  "apply_duration": 180,
  "timestamp": "2025-10-30T10:05:00Z"
}
```

---

## Stage 4: Drift Check

### Purpose
Execute a second `terraform apply` without configuration changes to verify no drift is detected, confirming state management correctness.

### Inputs

```yaml
required:
  - provider_binary: string      # Path to provider binary
  - state_file: string           # Path to state file from Apply stage
  - test_configuration: string   # Same config as Plan stage
  - terraform_version: string    # Same Terraform version
  
optional:
  - timeout_minutes: integer     # Drift check timeout (default: 10)
```

### Outputs

```yaml
success:
  - drift_detected: boolean      # Whether drift was detected (should be false)
  - plan_output: string          # Output of second plan
  - changes_count: integer       # Number of changes (should be 0)
  - drift_check_duration: integer  # Check time in seconds
  
failure:
  - error_type: enum             # "drift_detected" | "plan_error" | "timeout"
  - error_message: string        # Detailed error message
  - drift_details: []DriftInfo   # Details of detected drift
  - error_log: string            # Path to error log
```

### DriftInfo Schema

```yaml
resource_type: string           # Resource with drift
resource_name: string           # Name of drifted resource
attribute: string               # Attribute that changed
old_value: string               # Value in state
new_value: string               # New computed value
drift_type: enum                # "addition" | "modification" | "deletion"
```

### Success Criteria

1. Second `terraform plan` completes without errors
2. Plan shows "No changes. Your infrastructure matches the configuration."
3. No drift detected in any resource
4. Random values remain stable (same random seeds)
5. Drift check completes within timeout (10 minutes)

### Validation Checks

```yaml
drift_validation:
  - no_changes_detected: boolean
  - state_unchanged: boolean
  - random_seeds_stable: boolean
  - all_resources_match: boolean
  
common_drift_causes:
  - timestamps_in_names: boolean      # Should be false
  - unstable_random: boolean          # Should be false
  - computed_attributes: boolean      # Should be false
  - provider_version_change: boolean  # Should be false
```

### Error Handling

| Error Type | Action | Exit Code | Impact |
|------------|--------|-----------|--------|
| Drift detected | Fail pipeline, report drift | 30 | Critical |
| Plan error | Fail pipeline, log error | 31 | Critical |
| Timeout | Fail pipeline, report slow | 124 | Warning |

**Drift Detection is CRITICAL**: Any drift indicates a provider bug that could cause issues in production.

### Example Success Output

```json
{
  "stage": "drift_check",
  "status": "success",
  "drift_detected": false,
  "plan_output": "No changes. Your infrastructure matches the configuration.",
  "changes_count": 0,
  "drift_check_duration": 10,
  "timestamp": "2025-10-30T10:08:00Z"
}
```

### Example Failure Output

```json
{
  "stage": "drift_check",
  "status": "failure",
  "drift_detected": true,
  "error_type": "drift_detected",
  "error_message": "Drift detected in 2 resources",
  "drift_details": [
    {
      "resource_type": "azurecaf_name.storage",
      "resource_name": "st-dev-testapp-001",
      "attribute": "result",
      "old_value": "st-dev-testapp-001-abc",
      "new_value": "st-dev-testapp-001-xyz",
      "drift_type": "modification"
    }
  ],
  "timestamp": "2025-10-30T10:08:00Z"
}
```

---

## Stage 5: Cleanup

### Purpose
Remove all test resources and temporary files to prevent resource leakage and cost accumulation.

### Inputs

```yaml
required:
  - state_file: string           # Path to state file
  - terraform_version: string    # Terraform version used
  - provider_binary: string      # Path to provider binary
  
optional:
  - force_cleanup: boolean       # Force cleanup even if errors (default: true)
  - timeout_minutes: integer     # Cleanup timeout (default: 10)
  - cleanup_on_failure: boolean  # Cleanup even if previous stage failed (default: true)
```

### Outputs

```yaml
success:
  - resources_destroyed: integer  # Number of resources destroyed
  - cleanup_duration: integer     # Cleanup time in seconds
  - temp_files_removed: []string  # List of removed files
  
failure:
  - error_type: enum              # "destroy_error" | "timeout" | "resource_stuck"
  - error_message: string         # Detailed error message
  - cleanup_log: string           # Path to cleanup log
  - stuck_resources: []string     # Resources that couldn't be cleaned up
  - manual_cleanup_required: boolean
```

### Success Criteria

1. `terraform destroy` completes without errors
2. All resources are destroyed successfully
3. State file shows no remaining resources
4. All temporary files are removed
5. Cleanup completes within timeout (10 minutes)

### Cleanup Operations

```yaml
resources:
  - terraform_destroy: "Remove all resources from state"
  
files:
  - state_file: "Delete Terraform state"
  - plan_file: "Delete plan file"
  - provider_binary: "Delete compiled binary (optional)"
  - logs: "Compress and upload logs"
  - temp_directory: "Remove all temporary files"
```

### Error Handling

| Error Type | Action | Exit Code | Manual Action |
|------------|--------|-----------|---------------|
| Destroy error | Log error, retry once | 40 | Check Azure API |
| Timeout | Log error, continue | 124 | Verify resources deleted |
| Resource stuck | Log error, report | 41 | Manual deletion needed |

**Best Effort Cleanup**: Even if cleanup fails, pipeline should report success/failure of validation stages. Cleanup failures are warnings, not critical errors.

### Example Success Output

```json
{
  "stage": "cleanup",
  "status": "success",
  "resources_destroyed": 5,
  "cleanup_duration": 30,
  "temp_files_removed": [
    "/tmp/terraform.tfstate",
    "/tmp/terraform.tfplan",
    "/tmp/build.log"
  ],
  "timestamp": "2025-10-30T10:10:00Z"
}
```

---

## Pipeline Orchestration

### Sequential Flow

Each stage depends on the success of the previous stage:

```
Build (success) → Plan (success) → Apply (success) → Drift Check (success) → Cleanup
         ↓                ↓                ↓                      ↓                ↓
      Fail & Exit    Fail & Exit    Fail & Cleanup      Fail & Cleanup        Log Only
```

### Parallel Execution

Within a stage, multiple tests can run in parallel:

```yaml
parallel_strategy:
  max_parallel: 50                    # GitHub Actions limit
  grouping: "by_resource_category"    # Group similar resources
  isolation: "separate_directories"   # Each test in own directory
  state_isolation: "local_backend"    # No shared state
```

### Stage Dependencies

```yaml
dependencies:
  plan:
    requires: [build]
    inputs: [provider_binary]
    
  apply:
    requires: [plan]
    inputs: [provider_binary, plan_file]
    
  drift_check:
    requires: [apply]
    inputs: [provider_binary, state_file]
    
  cleanup:
    requires: [apply]  # Not drift_check, runs even if drift detected
    inputs: [state_file]
    always_run: true
```

### Timeout Strategy

```yaml
timeouts:
  build: 300        # 5 minutes
  plan: 300         # 5 minutes
  apply: 900        # 15 minutes
  drift_check: 600  # 10 minutes
  cleanup: 600      # 10 minutes
  total: 3600       # 60 minutes (safety limit)
```

---

## Complete Pipeline Contract

### Input Contract

```yaml
pipeline_input:
  required:
    - configuration_name: string      # "quick-pr" | "comprehensive-main" | "manual"
    - trigger_event: string           # "pull_request" | "push" | "workflow_dispatch"
    - git_ref: string                 # Branch or commit SHA
    
  optional:
    - resource_filter: []string       # Specific resources to test (default: all in config)
    - convention_filter: []string     # Specific conventions to test (default: all)
    - terraform_versions: []string    # Terraform versions to test (default: from config)
    - skip_cleanup: boolean           # Skip cleanup for debugging (default: false)
```

### Output Contract

```yaml
pipeline_output:
  status: enum                        # "success" | "failure" | "cancelled" | "timeout"
  validation_id: string               # Unique run identifier
  start_time: timestamp
  end_time: timestamp
  total_duration: integer
  
  stages:
    - build: StageResult
    - plan: StageResult
    - apply: StageResult
    - drift_check: StageResult
    - cleanup: StageResult
    
  metrics:
    total_tests: integer
    tests_passed: integer
    tests_failed: integer
    pass_rate: float
    average_test_duration: float
    
  artifacts:
    - build_log: string
    - test_results: string
    - coverage_report: string
    - drift_report: string
```

### Exit Codes

```yaml
exit_codes:
  0: "Success - all tests passed"
  1: "Build failure"
  2: "Dependency error"
  10: "Init error"
  11: "Plan error"
  12: "Validation error"
  20: "Apply error"
  21: "Resource error"
  22: "State error"
  30: "Drift detected (CRITICAL)"
  31: "Drift check plan error"
  40: "Cleanup error (WARNING)"
  41: "Resource stuck (WARNING)"
  124: "Timeout"
  125: "Configuration error"
  126: "Pipeline error"
```

---

## Contract Validation

### Pre-Flight Checks

Before executing pipeline:
1. Validate configuration file against schema
2. Verify all required inputs are provided
3. Check Terraform version is available
4. Confirm provider source code is accessible
5. Validate resource types exist in resourceDefinition.json

### Runtime Checks

During pipeline execution:
1. Verify each stage output conforms to contract
2. Validate dependencies are met before stage execution
3. Check timeouts are not exceeded
4. Confirm artifacts are created
5. Validate state transitions are correct

### Post-Execution Checks

After pipeline completion:
1. Verify all stages have results
2. Confirm cleanup was attempted
3. Check artifacts are accessible
4. Validate metrics are calculated
5. Ensure no resources were leaked (best effort)

---

## API Example (Conceptual)

### Trigger Validation

```bash
POST /api/v1/validation
{
  "configuration": "quick-pr",
  "git_ref": "feature-branch",
  "filters": {
    "resource_types": ["azurerm_storage_account"],
    "conventions": ["cafclassic"]
  }
}

Response:
{
  "validation_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "queued",
  "estimated_duration": 600
}
```

### Check Status

```bash
GET /api/v1/validation/550e8400-e29b-41d4-a716-446655440000

Response:
{
  "validation_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "running",
  "current_stage": "apply",
  "progress": 60,
  "stages": {
    "build": "success",
    "plan": "success",
    "apply": "running",
    "drift_check": "pending",
    "cleanup": "pending"
  }
}
```

### Get Results

```bash
GET /api/v1/validation/550e8400-e29b-41d4-a716-446655440000/results

Response:
{
  "validation_id": "550e8400-e29b-41d4-a716-446655440000",
  "status": "success",
  "total_duration": 450,
  "tests_passed": 20,
  "tests_failed": 0,
  "pass_rate": 1.0,
  "artifacts": {
    "logs": "https://artifacts/logs.tar.gz",
    "results": "https://artifacts/results.json"
  }
}
```

name: E2E Tests

on:
  # Run E2E tests on pull requests affecting critical paths
  pull_request:
    branches: [main]
    paths:
      - 'azurecaf/**'
      - 'e2e/**'
      - '*.go'
      - 'go.mod'
      - 'go.sum'
      - 'Makefile'
      - '.github/workflows/e2e.yml'
  
  # Run E2E tests on manual trigger
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of E2E tests to run'
        required: true
        default: 'all'
        type: choice
        options:
        - quick
        - all
        - import_only
        - naming_only
        - data_source_only

  # Run E2E tests on schedule (daily)
  schedule:
    - cron: '0 6 * * *'  # Run at 6 AM UTC daily

# Global environment variables
env:
  CHECKPOINT_DISABLE: 1
  TF_IN_AUTOMATION: 1
  TF_CLI_ARGS_init: "-upgrade=false"

# Restrict permissions for all jobs by default
permissions:
  contents: read

jobs:
  # Determine which tests to run based on trigger and inputs
  test-matrix:
    name: Determine Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.result }}
      run-full: ${{ steps.matrix.outputs.run-full }}
    steps:
      - name: Determine test matrix
        id: matrix
        run: |
          if [ "${{ github.event_name }}" == "schedule" ] || [ "${{ github.event.inputs.test_type }}" == "all" ]; then
            echo "run-full=true" >> $GITHUB_OUTPUT
            echo 'result=["quick", "data_source", "naming", "multiple_types", "import", "full"]' >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.test_type }}" == "quick" ] || [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "run-full=false" >> $GITHUB_OUTPUT
            echo 'result=["quick", "naming"]' >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.test_type }}" == "import_only" ]; then
            echo "run-full=false" >> $GITHUB_OUTPUT
            echo 'result=["import"]' >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.test_type }}" == "naming_only" ]; then
            echo "run-full=false" >> $GITHUB_OUTPUT
            echo 'result=["naming"]' >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.test_type }}" == "data_source_only" ]; then
            echo "run-full=false" >> $GITHUB_OUTPUT
            echo 'result=["data_source"]' >> $GITHUB_OUTPUT
          else
            echo "run-full=false" >> $GITHUB_OUTPUT
            echo 'result=["quick"]' >> $GITHUB_OUTPUT
          fi

  e2e-tests:
    name: E2E Tests (${{ matrix.test-type }})
    runs-on: ubuntu-latest
    needs: test-matrix
    strategy:
      fail-fast: false
      matrix:
        test-type: ${{ fromJson(needs.test-matrix.outputs.matrix) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: './go.mod'
          cache: true

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: go-deps-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            go-deps-

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.12.0"

      - name: Build Provider
        run: make build

      - name: Run E2E test
        run: |
          case "${{ matrix.test-type }}" in
            "quick")
              make test_e2e_quick
              ;;
            "data_source")
              make test_e2e_data_source
              ;;
            "naming")
              make test_e2e_naming
              ;;
            "multiple_types")
              make test_e2e_multiple_types
              ;;
            "import")
              make test_e2e_import
              ;;
            "full")
              make test_e2e
              ;;
            *)
              echo "Unknown test type: ${{ matrix.test-type }}"
              exit 1
              ;;
          esac

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results-${{ matrix.test-type }}
          path: |
            e2e/test-results/
            e2e/*.log
          retention-days: 7

  e2e-summary:
    name: E2E Test Summary
    runs-on: ubuntu-latest
    needs: [test-matrix, e2e-tests]
    if: always()
    
    steps:
      - name: Check E2E Test Results
        run: |
          if [ "${{ needs.e2e-tests.result }}" == "success" ]; then
            echo "✅ All E2E tests passed successfully!"
            if [ "${{ needs.test-matrix.outputs.run-full }}" == "true" ]; then
              echo "🎉 Full E2E test suite completed"
            else
              echo "⚡ Quick E2E tests completed"
            fi
          else
            echo "❌ E2E tests failed"
            echo "🔍 Please check the test outputs above"
            exit 1
          fi
